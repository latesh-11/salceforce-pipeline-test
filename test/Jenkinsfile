pipeline{
    agent any

    environment{
        PR_CREDENTIALS_ID = "PR_CONSUMER_KEY"
    }

    stages{
        stage("Code analysis"){
            steps{
                script {
                    sh "chmod +x test/bashScripts/countError.sh"
                    sh "./test/bashScripts/countError.sh"
                    echo "PMD Script - Commit at develop"
                }
            }
        }
        stage("Validate"){
           steps {
                script {
                     if (env.GIT_BRANCH == "origin/merge_requests/*"){
                        if (env.CHANGE_TARGET == 'QA') {
                            withCredentials([usernamePassword(credentialsId: "${PR_CREDENTIALS_ID}", passwordVariable: 'PR_CONSUMER_KEY', usernameVariable: 'PR_USERNAME')]) {
                                echo "  "
                                echo "Authenticating in Production.... ‚è±Ô∏è"
                                echo " "
                                sh "sf login org jwt --alias PR --client-id ${PR_CONSUMER_KEY} --jwt-key-file accesskey/server.key --set-default --set-default-dev-hub --instance-url https://login.salesforce.com --username ${PR_USERNAME}"
                                echo " "
                                echo "Successfully authenticated in Production ‚úÖ"
                                echo " "
                                echo "Validation started ... üîú"
                                sh "sf project deploy start -x manifest/package.xml --dry-run --target-org PR --ignore-warnings --verbose"
                            }
                        }
                    }
                }
           }
        }
    }
}



